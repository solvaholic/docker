name: Docker

on:
  push:
    # Run this workflow if */Dockerfile in main branch changed.
    branches:
      - main
    paths:
      - '*/Dockerfile'
      - '.github/workflows/dockerpush.yml'

jobs:
  # Build and push any Dockerfile changed in this push.
  buildandpush:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.after }}
          fetch-depth: '2'

      - name: List changed Dockerfiles
        # When a filename ending with /Dockerfile' has changed,
        # append it to a file named _files
        run: |
          git diff --name-only ${{ github.event.before }} \
          ${{ github.event.after }} | \
          sed -n -e "/\/Dockerfile$/p" > _files

      - name: Build image(s)
        # Get app name from parent dir, and build each Dockerfile:
        #   <repo-owner>/<app-name>:latest
        run: |
          echo "::debug::_files is ..." && cat _files
          : > _images
          cat _files | while read -r _thisfile; do
            _appname="${_thisfile%%/*}" _filename="${_thisfile##*/}"
            echo "::debug::_thisfile, _appname are ..." && \
            echo "${_thisfile} ${_appname}"
            if [ -f "${_thisfile}" ]; then
              _tag=${{ github.repository_owner }}/"${_appname}":latest
              tar c -C "${_appname}" . | docker build -t "${_tag}" -
              echo "${_tag}" >> _images
            fi
          done

      - name: Push image(s) to ghcr.io
        run: |
          echo "${{ secrets.PAT }}" | \
          docker login ghcr.io \
          -u ${{ github.actor }} --password-stdin
          echo "::debug::_images is ..." && cat _images
          cat _images | while read -r _thisimage; do
            # For GitHub's registry, prepend ghcr.io
            _mytag="ghcr.io/${_thisimage}"
            docker tag "${_thisimage}" "${_mytag}"
            echo "::debug::Pushing ${_mytag}"
            docker push "${_mytag}"
          done

      - name: Push image(s) to Docker hub
        run: |
          echo "${{ secrets.dockerhub_token }}" | \
          docker login -u ${{ github.actor }} --password-stdin
          echo "::debug::_images is ..." && cat _images
          cat _images | while read -r _thisimage; do
            # For Docker hub, use only the owner and topic names.
            _mytag="${_thisimage%%/*}/${_thisimage##*/}"
            docker tag "${_thisimage}" "${_mytag}"
            echo "::debug::Pushing ${_mytag}"
            docker push "${_mytag}"
          done
