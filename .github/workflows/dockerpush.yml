name: Docker

on:
  push:
    # Only run this workflow if */Dockerfile in master branch changed.
    branches:
      - master
    paths:
      - '*/Dockerfile'

jobs:
  # Build and push any Dockerfile changed in this push.
  buildandpush:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: '2'

      - name: List changed Dockerfiles
        run: |
          git diff --name-only ${{ github.event.before }} ${{ github.event.after }} | \
          sed -n -e "/\/Dockerfile$/p" > _files

      - name: Build image(s)
        run: |
          echo "::debug::_files is ..." && cat _files
          : > _images
          cat _files | while read _thisfile; do
            _appname=${_thisfile%%/*} _filename=${_thisfile##*/}
            echo "::debug::_thisfile, _appname are ..." && echo "${_thisfile} ${_appname}"
            if [ -f ${_thisfile} ]; then
              _tag=docker.pkg.github.com/${{ github.repository }}/${_appname}:latest
              cat ${_thisfile} | docker build -t ${_tag} -
              echo ${_tag} >> _images
            fi
          done
          echo "::set-env name=_images::${_myImages}"

      - name: Log into registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login docker.pkg.github.com -u ${{ github.actor }} --password-stdin

      - name: Push image(s)
        run: |
          echo "::debug::_images is ..." && cat _images
          cat _images | while read _thisimage; do
            echo "::debug::Pushing ${_thisimage}"
            docker push ${_thisimage}
          done
